<html>

<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>
    body {
      font-family: 'Lucida Sans', 'Lucida Grande', Geneva, Verdana, sans-serif;
    }

    .borough {
      stroke: #34495e;
      stroke-width: 1px;
    }

    .dot {
      opacity: 0.8;
    }

    .tooltip {
      position: absolute;
      visibility: hidden;
      padding: 5px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      white-space: nowrap;
    }

    .legend {
      font-size: 12px;
    }

    .title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 14px;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>
  <div class="title">NYC Traffic Accidents</div>
  <div class="subtitle">Interactive map showing accident locations and borough population density</div>
  <svg id="nyc-map" height="600" width="800"></svg>
  <div id="controls">
    <div>
      <label>Select Borough: </label>
      <select id="borough-select">
        <option value="all">All</option>
      </select>
    </div>
    <div>
      <label>Select Vehicle Type: </label>
      <select id="vehicle-type-select">
        <option value="all">All</option>
      </select>
    </div>

    <div id="tooltip" class="tooltip"></div>
    <svg id="legend" height="100" width="800"></svg>
  </div>

  <script>
    const svg = d3.select("#nyc-map");
    const width = svg.attr("width");
    const height = svg.attr("height");
    const legendSvg = d3.select("#legend");

    let minAccidents = 25;

    // Population data for each borough
    const populationData = {
      "Manhattan": 1644518,
      "Brooklyn": 2559903,
      "Queens": 2253858,
      "Bronx": 1472654,
      "Staten Island": 476143
    };

    // Color scale for borough population
    const boroughColorScale = d3.scaleLinear()
      .domain([476143, 2559903])
      .range(["#5faacb", "#2c7fb8"]);

    // Color scale for accidents
    const accidentColorScale = d3.scaleLinear()
      .domain([1, 25]) // Example range of accident counts
      .range(["#fee5d9", "#a50f15"]);

    const render = async () => {
      const boroughs = await d3.json('nyc_boroughs.topo.json');
      const boroughsFeature = topojson.feature(boroughs, boroughs.objects.nyc_boroughs);
      const collisions = await d3.csv('NYC_Collisions.csv');

      const projection = d3.geoMercator().fitSize([width, height], boroughsFeature);
      const path = d3.geoPath().projection(projection);

      // Populate borough dropdown
      d3.select("#borough-select")
        .selectAll("option.borough-option")
        .data(boroughsFeature.features)
        .join("option")
        .attr("class", "borough-option")
        .attr("value", d => d.properties.boro_name)
        .text(d => d.properties.boro_name);

      // Populate vehicle type dropdown
      const vehicleTypes = Array.from(new Set(collisions.map(d => d['Vehicle Type']).filter(Boolean)));
      d3.select("#vehicle-type-select")
        .selectAll("option.vehicle-option")
        .data(vehicleTypes)
        .join("option")
        .attr("class", "vehicle-option")
        .attr("value", d => d)
        .text(d => d);

      svg.selectAll(".borough")
        .data(boroughsFeature.features)
        .join("path")
        .attr("class", "borough")
        .attr("d", path)
        .attr("fill", d => boroughColorScale(populationData[d.properties.boro_name]));

      const tooltip = d3.select("#tooltip");

      const updateAccidents = () => {
        const selectedVehicleType = d3.select("#vehicle-type-select").property("value");
        const filteredCollisions = collisions.filter(d => {
          const vehicleTypeMatch = selectedVehicleType === 'all' || d['Vehicle Type'] === selectedVehicleType;
          return vehicleTypeMatch && d['Street Name'] && d.Latitude && d.Longitude;
        });

        const accidentsWithCoords = filteredCollisions.map(d => ({
          street: d['Street Name'], // Include the street name
          count: +d['Persons Injured'] || 0,
          coordinates: [+d.Longitude, +d.Latitude]
        })).filter(d => d.street && d.count && d.coordinates);

        const dots = svg.selectAll(".dot")
          .data(accidentsWithCoords);

        dots.enter()
          .append("circle")
          .attr("class", "dot")
          .attr("cx", d => projection(d.coordinates)[0])
          .attr("cy", d => projection(d.coordinates)[1])
          .attr("r", d => Math.sqrt(d.count))
          .attr("fill", d => accidentColorScale(d.count))
          .on("mouseover", function (event, d) {
            d3.select(this).style("fill", "#25d6fa");
            tooltip.style("visibility", "visible")
              .text(`Accidents: ${d.count}, Street: ${d.street}`);
          })
          .on("mousemove", event => {
            tooltip.style("top", `${event.pageY + 10}px`)
              .style("left", `${event.pageX + 10}px`);
          })
          .on("mouseout", () => {
            tooltip.style("visibility", "hidden");
          });

        dots.attr("cx", d => projection(d.coordinates)[0])
          .attr("cy", d => projection(d.coordinates)[1])
          .attr("r", d => Math.sqrt(d.count))
          .attr("fill", d => accidentColorScale(d.count));

        dots.exit().remove();
      };

      // Update accidents when vehicle type changes
      d3.select("#vehicle-type-select").on("change", updateAccidents);

      updateAccidents();
      const zoom = d3.zoom().on("zoom", (event) => {
        svg.selectAll('path').attr('transform', event.transform);
        svg.selectAll('circle').attr('transform', event.transform);
      });

      const zoomToBorough = (borough, boroughPath) => {
        const [[x0, y0], [x1, y1]] = path.bounds(borough);
        const scale = 0.8 / Math.max((x1 - x0) / width, (y1 - y0) / height);
        const translate = [
          width / 2 - scale * (x0 + x1) / 2,
          height / 2 - scale * (y0 + y1) / 2
        ];
        svg.transition().duration(750).call(
          zoom.transform,
          d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
        );

        if (selectedBoroughPath) {
          selectedBoroughPath.classed("highlighted", false);
        }

        selectedBoroughPath = boroughPath;
        selectedBoroughPath.classed("highlighted", true);
      };

      d3.select("#borough-select").on("change", function () {
        const selectedBorough = this.value;
        if (selectedBorough === "all") {
          svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
          if (selectedBoroughPath) {
            selectedBoroughPath.classed("highlighted", false);
            selectedBoroughPath = null;
          }
        } else {
          const borough = boroughsFeature.features.find(b => b.properties.boro_name === selectedBorough);
          const boroughPath = svg.selectAll(".borough").filter(d => d.properties.boro_name === selectedBorough);
          if (borough) zoomToBorough(borough, boroughPath);
        }
      });

      svg.call(zoom);


      // Add a legend
      const legendWidth = 200;
      const legendHeight = 10;

      legendSvg.append("g")
        .selectAll("rect")
        .data(accidentColorScale.ticks(10))
        .enter()
        .append("rect")
        .attr("x", (d, i) => i * legendWidth / 10)
        .attr("y", 0)
        .attr("width", legendWidth / 10)
        .attr("height", legendHeight)
        .attr("fill", d => accidentColorScale(d));

      legendSvg.append("text")
        .attr("x", 0)
        .attr("y", 30)
        .text("Accident Count");
    };

    render();

  </script>
</body>

</html>